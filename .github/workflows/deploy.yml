name: Deploy Music Assistant Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/serv/music-assistant

jobs:
  deploy:
    name: Deploy to Production
    runs-on: [self-hosted, linux]

    steps:
      - name: Verify runner
        run: |
          echo "Running on: $(hostname)"
          if [ ! -d "$DEPLOY_PATH" ]; then
            echo "ERROR: Deploy path $DEPLOY_PATH not found!"
            echo "This job is running on the wrong runner."
            echo "Please add label 'music-assistant' to the correct runner in GitHub Settings."
            exit 1
          fi
          echo "Deploy path verified: $DEPLOY_PATH"

      - name: Pull latest code
        run: |
          cd $DEPLOY_PATH
          git fetch origin main
          git reset --hard origin/main

      - name: Build Docker image
        run: |
          cd $DEPLOY_PATH
          docker compose build

      - name: Restart container
        run: |
          cd $DEPLOY_PATH
          docker compose down
          docker compose up -d

      - name: Wait for startup
        run: |
          echo "Waiting for Music Assistant to start..."
          sleep 30

      - name: Health check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8095/ || echo "000")
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "101" ]; then
            echo "Music Assistant is responding on port 8095"
          else
            echo "Status: $STATUS - checking logs..."
            docker logs music-assistant-server --tail 50
            exit 1
          fi

      - name: Show deployed version
        run: |
          cd $DEPLOY_PATH
          echo "Deployed commit: $(git rev-parse --short HEAD)"
          docker ps | grep music-assistant

      - name: Cleanup old images
        run: |
          docker image prune -f
          echo "Old images cleaned up"
