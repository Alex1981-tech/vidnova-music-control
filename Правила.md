# Media Assistant Server - Правила та документація

## Production сервер

**IP адреса:** `192.168.91.92`

**SSH доступ:**
```bash
ssh serv@192.168.91.92
# Пароль: 258456
```

**Шлях проекту:** `/home/serv/music-assistant`

**Дані:** `/home/serv/music-assistant/data`

> **Примітка:** Production сервер перенесено з 172.16.33.14 на 192.168.91.92 (09.01.2026).
> Тепер сервер знаходиться в тій же мережі що й LinkPlay пристрої (192.168.91.x).

---

## GitHub репозиторій

**URL:** https://github.com/Alex1981-tech/vidnova-music-control

**Гілка:** `main`

**Токен доступу:** див. `/root/WiiMplay_clinic/Інструкції для клода/гетхаб.md`

## CI/CD - Автоматичний деплой

### GitHub Actions Runner (Production - 192.168.91.92)

На production сервері налаштовано self-hosted runner:
- **Назва:** `music-assistant-server`
- **Розташування:** `/home/serv/actions-runner/`
- **Сервіс:** `actions.runner.Alex1981-tech-vidnova-music-control.music-assistant-server.service`

**Керування раннером (на 192.168.91.92):**
```bash
# Статус
sudo systemctl status actions.runner.Alex1981-tech-vidnova-music-control.music-assistant-server.service

# Перезапуск
sudo systemctl restart actions.runner.Alex1981-tech-vidnova-music-control.music-assistant-server.service

# Логи
journalctl -u actions.runner.Alex1981-tech-vidnova-music-control.music-assistant-server.service -f
```

### Старий Runner (Dev сервер - 172.16.33.14) - НЕ ВИКОРИСТОВУЄТЬСЯ

На старому сервері залишився runner (вимкнений):
- **Назва:** `vidnova-media-runner`
- **Розташування:** `/opt/github-runner-media/`

### Workflow деплою

При пуші в `main` гілку автоматично:
1. Синхронізується код на сервер
2. Зупиняється старий Docker контейнер
3. Будується новий Docker образ
4. Запускається новий контейнер

**Файл workflow:** `.github/workflows/deploy.yml`

---

## Порти

### Таблиця портів

| Сервіс | Production | Test | Опис |
|--------|------------|------|------|
| **Web API** | 8095 | 10100 | Веб-інтерфейс та WebSocket API |
| **Stream** | 8097 | 10101 | Стрім-сервер (аудіо для плеєрів) |
| **Sendspin** | 8927 | 10102 | Протокол синхронізованого аудіо |

### Що таке Sendspin?

**Sendspin** - це вбудований протокол синхронізованого аудіо, розроблений Open Home Foundation. Він дозволяє:

- **Синхронізоване мультирум аудіо** - точна синхронізація відтворення між пристроями
- **Відтворення у браузері** - слухати музику прямо у веб-інтерфейсі через WebRTC
- **Мобільні додатки** - підтримка iOS/Android клієнтів
- **Апаратні пристрої** - підключення ESPHome та інших пристроїв

Підключення:
- Браузер: автоматично через WebRTC
- Локальна мережа: `ws://<server-ip>:8927/sendspin`

---

## Production - Docker (192.168.91.92)

### Контейнер

- **Назва:** `music-assistant-server`
- **Образ:** `music-assistant-server:latest`
- **Дані:** `/home/serv/music-assistant/data`
- **Мережа:** `network_mode: host` (прямий доступ до 192.168.91.xxx)

**Керування контейнером (SSH на 192.168.91.92):**
```bash
# Статус
docker ps | grep music-assistant-server

# Логи
docker logs music-assistant-server --tail 100
docker logs music-assistant-server -f

# Перезапуск через docker-compose
cd /home/serv/music-assistant
docker compose restart

# Повна перезбірка
cd /home/serv/music-assistant
docker compose down
docker compose build
docker compose up -d
```

### Доступ

- **Веб-інтерфейс:** http://192.168.91.92:8095
- **API:** ws://192.168.91.92:8095/ws
- **Stream Server:** http://192.168.91.92:8097

---

## Test/Dev - Host (systemd) на 172.16.33.14

> **Примітка:** Тестовий сервер залишився на старому сервері 172.16.33.14

### Сервіс

- **Назва:** `media-assistant-test.service`
- **Дані:** `/root/.musicassistant-test/`
- **Python:** `/root/server-2.8.0.dev2026010704/.venv/bin/python`

**Керування тестовим сервером (на 172.16.33.14):**
```bash
# Запуск
systemctl start media-assistant-test

# Зупинка
systemctl stop media-assistant-test

# Перезапуск
systemctl restart media-assistant-test

# Статус
systemctl status media-assistant-test

# Логи
journalctl -u media-assistant-test -f
journalctl -u media-assistant-test --tail 100
```

### Доступ

- **Веб-інтерфейс:** http://172.16.33.14:10100
- **API:** ws://172.16.33.14:10100/ws

### Налаштування портів

Порти налаштовуються в `/root/.musicassistant-test/settings.json`:
```json
{
  "core": {
    "webserver": {
      "values": { "bind_port": 10100 }
    },
    "streams": {
      "values": { "bind_port": 10101 }
    }
  }
}
```

Sendspin порт налаштовується через змінну `SENDSPIN_PORT` в systemd сервісі (`/etc/systemd/system/media-assistant-test.service`).

---

## Дані (повністю автономні)

### Production (192.168.91.92): `/home/serv/music-assistant/data/`

### Test (172.16.33.14): `/root/.musicassistant-test/`

Всі дані зберігаються на хості і НЕ видаляються при оновленні контейнера:

| Файл/Папка | Опис |
|------------|------|
| `auth.db` | База даних аутентифікації |
| `library.db` | База даних музичної бібліотеки |
| `schedule.db` | База даних розкладів |
| `settings.json` | Налаштування сервера (включаючи порти) |
| `.cache/` | Кеш (обкладинки, метадані) |
| `music/` | Музичні файли |
| `video/` | Відеофайли |
| `video_thumbnails/` | Мініатюри відео |
| `playlists/` | Плейлисти |
| `announcements/` | Оголошення |

**Резервне копіювання:**
```bash
# Бекап production (на 192.168.91.92)
ssh serv@192.168.91.92 "tar -czvf ~/backup/musicassistant-$(date +%Y%m%d).tar.gz ~/music-assistant/data/"

# Бекап test (на 172.16.33.14)
tar -czvf /root/backup/musicassistant-test-$(date +%Y%m%d).tar.gz /root/.musicassistant-test/
```

---

## Структура проекту

```
/root/server-2.8.0.dev2026010704/
├── music_assistant/          # Серверний код (Python)
├── music_assistant_frontend/ # Вбудований фронтенд (Vue.js)
├── .venv/                    # Python virtual environment
├── Dockerfile.prod           # Docker образ для production
├── docker-compose.prod.yml   # Docker Compose конфіг
├── .github/workflows/        # GitHub Actions
│   └── deploy.yml           # Автодеплой workflow
├── requirements_all.txt      # Python залежності
└── pyproject.toml           # Конфіг проекту
```

**Systemd сервіси:**
- `/etc/systemd/system/media-assistant-test.service` - тестовий сервер

---

## Мережа

### Production (192.168.91.92)
Сервер працює в тій же мережі що й LinkPlay пристрої:
- **192.168.91.92** - IP сервера
- **192.168.91.xxx** - мережа LinkPlay пристроїв (WiiM, Muzo)

### Dev/Test (172.16.33.14)
Старий сервер, зараз використовується тільки для розробки:
- **172.16.33.14** - IP сервера
- Має маршрутизацію до 192.168.91.xxx

---

## Оновлення коду

### Автоматично (рекомендовано)

На dev сервері (172.16.33.14):
```bash
cd /root/server-2.8.0.dev2026010704
git add -A
git commit -m "Опис змін"
git push origin main
# Деплой production на 192.168.91.92 відбудеться автоматично через GitHub Actions
```

### Вручну на Production (192.168.91.92)
```bash
ssh serv@192.168.91.92
cd /home/serv/music-assistant
git pull origin main
docker compose down
docker compose build
docker compose up -d
```

---

## Моніторинг

### Production (192.168.91.92)
```bash
ssh serv@192.168.91.92

# Перевірка здоров'я
curl -s http://localhost:8095/ | head -20

# Логи контейнера
docker logs music-assistant-server --tail 100
docker logs music-assistant-server -f

# Статус
docker ps | grep music-assistant-server

# Ресурси
docker stats music-assistant-server --no-stream
```

### Test (172.16.33.14)
```bash
# Перевірка здоров'я
curl -s http://localhost:10100/ | head -20

# Логи
journalctl -u media-assistant-test --tail 100
journalctl -u media-assistant-test -f

# Статус
systemctl status media-assistant-test
```

---

## Важливо

1. **НЕ видаляйте** `/home/serv/music-assistant/data/` на 192.168.91.92 - там всі production дані!
2. **Бекапте** регулярно папку з даними
3. При проблемах спочатку дивіться логи: `docker logs music-assistant-server --tail 100`
4. Контейнери автоматично перезапускаються при падінні (`restart: unless-stopped`)
5. Production (192.168.91.92) і Test (172.16.33.14) використовують різні бази даних
6. Production сервер тепер в тій же мережі що й LinkPlay пристрої - стрімінг працює напряму
