# Media Assistant Server - Правила та документація

## GitHub репозиторій

**URL:** https://github.com/Alex1981-tech/vidnova-music-control

**Гілка:** `main`

**Токен доступу:** див. `/root/WiiMplay_clinic/Інструкції для клода/гетхаб.md`

## CI/CD - Автоматичний деплой

### GitHub Actions Runner

На сервері налаштовано self-hosted runner:
- **Назва:** `vidnova-media-runner`
- **Розташування:** `/opt/github-runner-media/`
- **Сервіс:** `actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service`

**Керування раннером:**
```bash
# Статус
systemctl status actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service

# Перезапуск
systemctl restart actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service

# Логи
journalctl -u actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service -f
```

### Workflow деплою

При пуші в `main` гілку автоматично:
1. Синхронізується код на сервер
2. Зупиняється старий Docker контейнер
3. Будується новий Docker образ
4. Запускається новий контейнер

**Файл workflow:** `.github/workflows/deploy.yml`

---

## Порти

### Таблиця портів

| Сервіс | Production | Test | Опис |
|--------|------------|------|------|
| **Web API** | 8095 | 10100 | Веб-інтерфейс та WebSocket API |
| **Stream** | 8097 | 10101 | Стрім-сервер (аудіо для плеєрів) |
| **Sendspin** | 8927 | 10102 | Протокол синхронізованого аудіо |

### Що таке Sendspin?

**Sendspin** - це вбудований протокол синхронізованого аудіо, розроблений Open Home Foundation. Він дозволяє:

- **Синхронізоване мультирум аудіо** - точна синхронізація відтворення між пристроями
- **Відтворення у браузері** - слухати музику прямо у веб-інтерфейсі через WebRTC
- **Мобільні додатки** - підтримка iOS/Android клієнтів
- **Апаратні пристрої** - підключення ESPHome та інших пристроїв

Підключення:
- Браузер: автоматично через WebRTC
- Локальна мережа: `ws://<server-ip>:8927/sendspin`

---

## Production - Docker

### Контейнер

- **Назва:** `media-assistant-server`
- **Образ:** `media-assistant-server:latest`
- **Дані:** `/root/.musicassistant/`
- **Мережа:** `network_mode: host` (доступ до 192.168.91.xxx)

**Керування контейнером:**
```bash
# Статус
docker ps | grep media-assistant-server

# Логи
docker logs media-assistant-server --tail 100
docker logs media-assistant-server -f

# Перезапуск
docker restart media-assistant-server

# Зупинка
docker stop media-assistant-server

# Ручний запуск
docker run -d \
  --name media-assistant-server \
  --restart unless-stopped \
  --network host \
  -v /root/.musicassistant:/data \
  -e TZ=Europe/Kyiv \
  media-assistant-server:latest
```

### Доступ

- **Веб-інтерфейс:** http://172.16.33.14:8095
- **API:** ws://172.16.33.14:8095/ws

---

## Test - Host (systemd)

### Сервіс

- **Назва:** `media-assistant-test.service`
- **Дані:** `/root/.musicassistant-test/`
- **Python:** `/root/server-2.8.0.dev2026010704/.venv/bin/python`

**Керування тестовим сервером:**
```bash
# Запуск
systemctl start media-assistant-test

# Зупинка
systemctl stop media-assistant-test

# Перезапуск
systemctl restart media-assistant-test

# Статус
systemctl status media-assistant-test

# Логи
journalctl -u media-assistant-test -f
journalctl -u media-assistant-test --tail 100
```

### Доступ

- **Веб-інтерфейс:** http://172.16.33.14:10100
- **API:** ws://172.16.33.14:10100/ws

### Налаштування портів

Порти налаштовуються в `/root/.musicassistant-test/settings.json`:
```json
{
  "core": {
    "webserver": {
      "values": { "bind_port": 10100 }
    },
    "streams": {
      "values": { "bind_port": 10101 }
    }
  }
}
```

Sendspin порт налаштовується через змінну `SENDSPIN_PORT` в systemd сервісі (`/etc/systemd/system/media-assistant-test.service`).

---

## Дані (повністю автономні)

### Production: `/root/.musicassistant/`

### Test: `/root/.musicassistant-test/`

Всі дані зберігаються на хості і НЕ видаляються при оновленні контейнера:

| Файл/Папка | Опис |
|------------|------|
| `auth.db` | База даних аутентифікації |
| `library.db` | База даних музичної бібліотеки |
| `schedule.db` | База даних розкладів |
| `settings.json` | Налаштування сервера (включаючи порти) |
| `.cache/` | Кеш (обкладинки, метадані) |
| `music/` | Музичні файли |
| `video/` | Відеофайли |
| `video_thumbnails/` | Мініатюри відео |
| `playlists/` | Плейлисти |
| `announcements/` | Оголошення |

**Резервне копіювання:**
```bash
# Бекап production
tar -czvf /root/backup/musicassistant-$(date +%Y%m%d).tar.gz /root/.musicassistant/

# Бекап test
tar -czvf /root/backup/musicassistant-test-$(date +%Y%m%d).tar.gz /root/.musicassistant-test/

# Відновлення
tar -xzvf /root/backup/musicassistant-XXXXXXXX.tar.gz -C /
```

---

## Структура проекту

```
/root/server-2.8.0.dev2026010704/
├── music_assistant/          # Серверний код (Python)
├── music_assistant_frontend/ # Вбудований фронтенд (Vue.js)
├── .venv/                    # Python virtual environment
├── Dockerfile.prod           # Docker образ для production
├── docker-compose.prod.yml   # Docker Compose конфіг
├── .github/workflows/        # GitHub Actions
│   └── deploy.yml           # Автодеплой workflow
├── requirements_all.txt      # Python залежності
└── pyproject.toml           # Конфіг проекту
```

**Systemd сервіси:**
- `/etc/systemd/system/media-assistant-test.service` - тестовий сервер

---

## Мережа

Сервер працює з `network_mode: host`, тому бачить всі мережі хоста:
- **172.16.33.14** - основна мережа сервера
- **192.168.91.xxx** - мережа LinkPlay пристроїв (WiiM, Muzo)

---

## Оновлення коду

### Автоматично (рекомендовано)
```bash
cd /root/server-2.8.0.dev2026010704
git add -A
git commit -m "Опис змін"
git push origin main
# Деплой production відбудеться автоматично через GitHub Actions
```

### Вручну
```bash
cd /root/server-2.8.0.dev2026010704
docker stop media-assistant-server
docker rm media-assistant-server
docker build -f Dockerfile.prod -t media-assistant-server:latest .
docker run -d \
  --name media-assistant-server \
  --restart unless-stopped \
  --network host \
  -v /root/.musicassistant:/data \
  -e TZ=Europe/Kyiv \
  media-assistant-server:latest
```

---

## Моніторинг

```bash
# Перевірка здоров'я production (Docker)
curl -s http://localhost:8095/ | head -20
docker logs media-assistant-server --tail 100

# Перевірка здоров'я test (systemd)
curl -s http://localhost:10100/ | head -20
journalctl -u media-assistant-test --tail 100

# Статус всіх серверів
docker ps | grep media-assistant-server
systemctl status media-assistant-test

# Використання ресурсів
docker stats media-assistant-server --no-stream
```

---

## Важливо

1. **НЕ видаляйте** `/root/.musicassistant/` - там всі production дані!
2. **Бекапте** регулярно папку `/root/.musicassistant/`
3. При проблемах спочатку дивіться логи: `docker logs <container> --tail 100`
4. Контейнери автоматично перезапускаються при падінні (`--restart unless-stopped`)
5. Production і Test використовують різні бази даних та налаштування
