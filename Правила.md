# Media Assistant Server - Правила та документація

## GitHub репозиторій

**URL:** https://github.com/Alex1981-tech/vidnova-music-control

**Гілка:** `main`

**Токен доступу:** див. `/root/WiiMplay_clinic/Інструкції для клода/гетхаб.md`

## CI/CD - Автоматичний деплой

### GitHub Actions Runner

На сервері налаштовано self-hosted runner:
- **Назва:** `vidnova-media-runner`
- **Розташування:** `/opt/github-runner-media/`
- **Сервіс:** `actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service`

**Керування раннером:**
```bash
# Статус
systemctl status actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service

# Перезапуск
systemctl restart actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service

# Логи
journalctl -u actions.runner.Alex1981-tech-vidnova-music-control.vidnova-media-runner.service -f
```

### Workflow деплою

При пуші в `main` гілку автоматично:
1. Синхронізується код на сервер
2. Зупиняється старий Docker контейнер
3. Будується новий Docker образ
4. Запускається новий контейнер

**Файл workflow:** `.github/workflows/deploy.yml`

## Production - Docker

### Контейнер

- **Назва:** `media-assistant-server`
- **Порти:** 8095 (веб), 8097 (стрім), 8927 (Sendspin)
- **Мережа:** `network_mode: host` (доступ до всіх мереж хоста, включаючи 192.168.91.xxx)

**Керування контейнером:**
```bash
# Статус
docker ps | grep media-assistant

# Логи
docker logs media-assistant-server --tail 100
docker logs media-assistant-server -f

# Перезапуск
docker restart media-assistant-server

# Зупинка
docker stop media-assistant-server

# Ручний запуск
docker run -d \
  --name media-assistant-server \
  --restart unless-stopped \
  --network host \
  -v /root/.musicassistant:/data \
  -e TZ=Europe/Kyiv \
  media-assistant-server:latest
```

### Дані (повністю автономні)

**Розташування:** `/root/.musicassistant/`

Всі дані зберігаються на хості і НЕ видаляються при оновленні контейнера:

| Файл/Папка | Опис |
|------------|------|
| `auth.db` | База даних аутентифікації |
| `library.db` | База даних музичної бібліотеки |
| `schedule.db` | База даних розкладів |
| `settings.json` | Налаштування сервера |
| `.cache/` | Кеш (обкладинки, метадані) |
| `music/` | Музичні файли |
| `video/` | Відеофайли |
| `video_thumbnails/` | Мініатюри відео |
| `playlists/` | Плейлисти |
| `announcements/` | Оголошення |

**Резервне копіювання:**
```bash
# Бекап всіх даних
tar -czvf /root/backup/musicassistant-$(date +%Y%m%d).tar.gz /root/.musicassistant/

# Відновлення
tar -xzvf /root/backup/musicassistant-XXXXXXXX.tar.gz -C /
```

## Структура проекту

```
/root/server-2.8.0.dev2026010704/
├── music_assistant/          # Серверний код (Python)
├── music_assistant_frontend/ # Вбудований фронтенд (Vue.js)
├── Dockerfile.prod           # Docker образ для production
├── docker-compose.prod.yml   # Docker Compose конфіг
├── .github/workflows/        # GitHub Actions workflows
│   └── deploy.yml           # Автодеплой workflow
├── requirements_all.txt      # Python залежності
└── pyproject.toml           # Конфіг проекту
```

## Мережа

Сервер працює з `network_mode: host`, тому бачить всі мережі хоста:
- **172.16.33.14** - основна мережа сервера
- **192.168.91.xxx** - мережа LinkPlay пристроїв (WiiM, Muzo)

**Порти:**
- `8095` - веб-інтерфейс та API
- `8097` - стрім-сервер (аудіо для плеєрів)
- `8927` - Sendspin сервер

## Оновлення коду

### Автоматично (рекомендовано)
```bash
cd /root/server-2.8.0.dev2026010704
git add -A
git commit -m "Опис змін"
git push origin main
# Деплой відбудеться автоматично через GitHub Actions
```

### Вручну
```bash
cd /root/server-2.8.0.dev2026010704
docker stop media-assistant-server
docker rm media-assistant-server
docker build -f Dockerfile.prod -t media-assistant-server:latest .
docker run -d \
  --name media-assistant-server \
  --restart unless-stopped \
  --network host \
  -v /root/.musicassistant:/data \
  -e TZ=Europe/Kyiv \
  media-assistant-server:latest
```

## Моніторинг

```bash
# Перевірка здоров'я
curl -s http://localhost:8095/ | head -20

# Статус контейнера
docker inspect media-assistant-server --format='{{.State.Health.Status}}'

# Використання ресурсів
docker stats media-assistant-server --no-stream
```

## Важливо

1. **НЕ видаляйте** `/root/.musicassistant/` - там всі дані!
2. **Бекапте** регулярно папку `/root/.musicassistant/`
3. При проблемах спочатку дивіться логи: `docker logs media-assistant-server --tail 100`
4. Контейнер автоматично перезапускається при падінні (`--restart unless-stopped`)
